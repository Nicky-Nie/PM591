---
title: "PM591 Assignment01"
output:
  html_document:
    df_print: paged
---
Learning objectives.

- Split data into **training** and **test** data in ``R``
- Train/fit a linear regression model in ``R``
- Evaluate **prediction performance** of a linear regression model
- Perform small simulation study

### Analysis
You will recreate and extend the analysis of the brain weight data.

1. Read in (``red.table``) the Brain weight dataset. Examine (``head``) and summarize (``summary``) the data.
```{r}
brain <- read.table("brain.csv", header = TRUE)
head(brain)
summary(brain)
```

2. Convert Sex and Age to factor variables so that ``lm`` can properly deal with them.
```{r}
brain$Sex <- factor(brain$Sex, levels = 1:2, labels = c("Male","Female"))
brain$Age <- factor(brain$Age, levels = 1:2, labels = c("20-46","46+"))
```


3. Split the data into training (70%) and test (30%) sets.
```{r}
set.seed(11)
n <- nrow(brain)
trainset <- sample(1:n, floor(0.7*n))
brain_train <- brain[trainset,]
n_train <- nrow(brain_train)
brain_test <- brain[-trainset,]
n_test <- nrow(brain_test)
```

4. Fit a linear regression model with brain weight as the outcome and head Size, Sex, and Age as predictors. What is the interpretation of the coefficients for Sex and Age? Compute the training and test RMSE and $R^2$. Does adding Age improves *prediction performance* over the model with Sex and Head size alone?
```{r}
model1 <- lm(Brain.weight~Sex+Head.size, data = brain_train)
RMSE_train1 <-sqrt(sum(residuals(model1)^2)/n_train)
RSS1 <- sum(residuals(model1)^2)
TSS1 <- sum((brain_train$Brain.weight-mean(brain_train$Brain.weight))^2)
R2_train1 <- 1-RSS1/TSS1
pred1 <- predict(model1, newdata = brain_test)
RMSE_test1 <- sqrt(sum(brain_test$Brain.weight-pred1)^2)/n_test
R2_test1 <- 1-sqrt(sum(brain_test$Brain.weight-pred1)^2)/sum((brain_test$Brain.weight-mean(brain_test$Brain.weight))^2)
RMSE_train1
RMSE_test1
R2_train1
R2_test1
```

```{r}
model2 <- lm(Brain.weight~Sex+Head.size+Age, data = brain_train)
RMSE_train2 <-sqrt(sum(residuals(model2)^2)/n_train)
RSS2 <- sum(residuals(model2)^2)
TSS2 <- sum((brain_train$Brain.weight-mean(brain_train$Brain.weight))^2)
R_square2 <- 1-RSS1/TSS1
RMSE_train2
R_square2
```

5. Explore whether fitting a linear regression model with separate intercepts and separate slopes for $20 \le$ Age $<$ 46 and Age $\ge$ 46 improves prediction performance (hint: you can, for example, specify an interaction between Sex and Head size including `` Head.Size:Age`` in the model formula.

### Simulation
You will perform a small simulation study to investigate the degree to which assessing prediction performance in *the same data* used to train/fit a model -- rather than using a separate test dataset -- leads to an overly optimistic assessment of prediction performance. Of particular interest is to investigate how the degree of overoptimistic assessment is affected by i) the size of the training data and ii) the level of noise in the data. The simulation will loosely mimic the brain weight data.

1. Set the training sample size to ``n_train=100``, the test sample size to ``n_test=50``, and the total sample size to ``n = n_train + n_test = 150`` (the train/test split is 2/3 train to 1/3 test rather than the more usual 0.8 to 0.2 to prevent the test set from being too small).
```{r}
set.seed(12)
n_train <- 100
n_test <- 50
n <- n_train + n_test
```

2. Generate a variable/vector ``Head.size`` of size ``n`` drawn from a normal distribution with population mean and population standard deviations equal to the sample mean and sample standard deviation, respectively, of the Head.Size variable in the real brain weight data.
```{r}
Head.size <- rnorm(n, mean = mean(brain$Head.size), sd = sd(brain$Head.size))
```


3. Generate a binary variable/vector ``Sex``= Female/Male of size ``n`` with a population frequency of Sex==Female/Male matching the observed frequencies of the variable Sex in the real brain weight data (hint: use ``rbinom`` to generate samples form a binomial distribution: ``rbinom(n, size=1, prob=Malefreq)``, where ``Malefreq`` was previously computed).
```{r}
Malefreq <- sum(brain$Sex == "Male")/length(brain$Sex)
Sex <- rbinom(n, size = 1, prob = Malefreq)
```

4. Similarly, generate a binary variable/vector ``Age``= <= 46/ > 46 with population frequencies for <= 46 and > 46 matching the observed frequencies of the variable Age in the the real brain weight data.
```{r}
youngfreq <- sum(brain$Age == "20-46")/length(brain$Age)
Age <- rbinom(n, size = 1, prob = youngfreq)
```


5. Generate a variable/vector ``Brain.weight`` of size ``n`` according to the linear model ``Brain.weight = b0 + ba * Age + bs * Sex + bh * Head.size``. Use the coefficients $\widehat{\beta_0}, \widehat{\beta_{A}},  \widehat{\beta_{S}}$, and $\widehat{\beta_{H}}$ obtained from fitting the corresponding linear regression model to the full real brain weight dataset. 
```{r}
lm_model <- lm(Brain.weight~Age+Sex+Head.size, data = brain)
beta_0 <- summary(lm_model)$coefficients[1,1]
beta_A <- summary(lm_model)$coefficients[2,1]
beta_S <- summary(lm_model)$coefficients[3,1]
beta_H <- summary(lm_model)$coefficients[4,1]
Brain.weight <- beta_0 + beta_A*Age + beta_S*Sex + beta_H * Head.size
```

6. Generate a noise/error vector ``noise`` of size ``n`` drawn from a normal distribution with mean 0 and variance equal to that of the residual variance in the linear regression model fitted above on the full real brain weight dataset. Add the noise to Brain.weight: ``Brain.weight = Brain.weight + noise``.
```{r}
noise <- rnorm(n, mean=0, sd = summary(lm_model)$sigma)
Brain.weight <- Brain.weight + noise
```


7. Construct a dataframe containing the generated variables ``Sex``, ``Age``, ``Brain.weight``, and ``Head.size`` 
```{r}
brain_new <- data.frame(Sex, Age, Brain.weight, Head.size)
```


8. Split the data into training (``size n_train``) and test (``size n_test``) sets.
```{r}
train <- sample(1:n, n_train)
train_set <- brain_new[train,]
test_set <- brain_new[-train,]
```


9. Fit the model ``Brain.weight ~ b0 + ba * Age + bs * Sex + bh * Head.size`` to the training data.
```{r}
lm_model2 <- lm(Brain.weight~Age+Sex+Head.size, data = train_set)
```


10. Compute the training and test RMSE and $R^2$.
```{r}

```


11. Repeat steps 2 to 10 100 times (save the RMSE's and $R^2$'s from each simulation replicate).

12. Compute the average training and test RMSE ($R^2$) across the 100 simulation replicates. 

13. Visually (e.g. scatter plot, boxplot) evaluate the degree of optimistic assessment when
training and testing on the same data.

14. Comment on the results of the simulation.

15. Investigate how the results change as the standard deviation of the noise variable ``noise`` gets larger (say 1.5- and 2-fold lager than in the baseline simulation). Summarize and comment on your results.
 




